#!/usr/bin/env zsh

# === {{CMD}}  watch|run
if [[ -z "$@" ]]; then
  local +x ACTION="watch"
else
  local +x ACTION="$1"; shift
fi

case "$ACTION" in
  static)
    ASSET_COMPILE="yes" my_crystal __ build src/megauni.cr -o tmp/out/megauni.static
    tmp/out/megauni.static
    ;;

  run)
    reset
    mkdir -p tmp/in tmp/out

    sh_color ORANGE "=== {{Compiling}} static assets..."
    megauni.cr dev static

    sh_color ORANGE "=== {{Compiling}} server..."
    DEVELOPMENT=yes my_crystal __ build src/megauni/server.cr -o tmp/out/megauni.server

    sh_color ORANGE "=== {{Terminating}} previous server..."
    pkill -f "tmp/out/megauni.server" || :

    sh_color ORANGE "=== {{Running}}..."
    HTTP_SERVER_SESSION_SECRET="0x340x46nasfiermoe$(date +%s)" tmp/out/megauni.server &
    my_network inspect "http://localhost:3000/"
    my_network inspect "http://localhost:3000/megauni/files/root/main.css"
    ;;

  watch)
    local +x CMD="$APP_NAME dev run"
    ${=CMD} || :
    process watch "-r src -r bin -r sh -r specs" "$CMD"
    ;;

  *)
    sh_color RED "=== Unknown command: {{$ACTION $@}}"
    exit 2
    ;;
esac

